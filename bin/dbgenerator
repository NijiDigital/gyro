#!/usr/bin/env ruby

if RUBY_VERSION < '2.0.0'
  abort 'error: DBGenerator requires Ruby 2 or higher.'
end

if $0 == __FILE__
  $:.unshift File.expand_path('../lib', File.dirname(__FILE__))
end
require 'dbgenerator'
require 'optparse'

dir = Dir.pwd
options = {
    :model => nil,
    :android_dir => nil,
    :package => nil,
    :ios_dir => nil,
    :ios_json => false,
    :ios_framework => false,
    :ios_swift => false
}

OptionParser.new do |opts|
  opts.banner = 'Usage: dbgenerator [options]'
  opts.on('-m PATH', '--model PATH', %q(Specify Interface Builder .xcdatamodel file)) do |path|
    options[:model] = path
  end
  opts.on('-a PATH', '--android PATH', %q(Specify Android Realm model classes dir)) do |path|
    options[:android_dir] = path
  end
  opts.on('-p PATH', '--package PATH', %q(Specify Android Realm model classes package name)) do |path|
    options[:package] = path
  end
  opts.on('-i PATH', '--ios PATH', %q(Specify iOS Realm model classes dir)) do |path|
    options[:ios_dir] = path
  end
  opts.on('-j', '--json', %q(Additionally generate Realm-JSON categories (Objective-C) or ObjectMapper artifacts (Swift))) do
    options[:ios_json] = true
  end
  opts.on('-f', '--framework', %q(If you use CocoaPods Frameworks instead of static libraries)) do
    options[:ios_framework] = true
  end
  opts.on('-s', '--swift', %q(If you use Swift as iOS language)) do
    options[:ios_swift] = true
  end
  opts.on('-n', '--nsnumber', %q(To generate NSNumbers instead of Int/BOOL/Float types)) do
    options[:ios_nsnumber] = true
  end
  opts.on_tail('-h', '--help', %q(Show this message)) { puts opts; exit 1 }
  opts.on_tail('-v', '--version', 'Show version') { puts DBGenerator::VERSION; exit }
  opts.parse!
end

if options[:model].nil?
  Log::info('No model provided, trying to find one in the local directoryâ€¦')
  options[:model] = File.find_xcdatamodel(dir)
  Log::info("Unable to find any .xcdatamodel in #{dir}") if options[:model].nil?
end

if options[:model].nil?
  DBGenerator.exit_with_error('You need to specify .xcdatamodel path using --model option (see --help for more info)')
else
  basename = File.basename(options[:model])
  dirname = File.dirname(options[:model])
  Log::success("Using #{basename} in #{dirname}")
end

# Android
if options[:android_dir].nil?
  Log::info('You need to specify a dir using --android option to generate Android Realm model classes (see --help for more info)')
else
  if Dir.exist?(options[:android_dir])
    if options[:package].nil?
      Log::info('You need to specify an Android package name using --package option (see --help for more info)')
    else
      xcdatamodel = DBGenerator::XCDataModel::Parser::XCDataModel.new(options[:model])
      DBGenerator::Realm::Java::Generator.new(options[:android_dir], options[:package], xcdatamodel)
    end
  else
    Log::info('You need to specify a valid Android Realm model classes dir')
  end
end

# iOS
if options[:ios_dir].nil?
  Log::info('You need to specify a dir using --ios option to generate iOS Realm model classes (see --help for more info)')
else
  if Dir.exist?(options[:ios_dir])
    xcdatamodel = DBGenerator::XCDataModel::Parser::XCDataModel.new(options[:model])
    if options[:ios_swift]
      DBGenerator::Realm::Swift::Generator.new(options[:ios_dir], xcdatamodel, options[:ios_json])
    else
      DBGenerator::Realm::ObjC::Generator.new(options[:ios_dir], xcdatamodel, options[:ios_json], options[:ios_framework], options[:ios_nsnumber])
    end
  else
    Log::info('You need to specify a valid iOS Realm model classes dir')
  end
end
